----------------------------------------------------------------------------------------------------
module private hash_tables =
-- Data structures - hash tables.
-- Flex Standard Library
-- Copyright (C) 1999-2003 A && L soft
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
class private c_hash_table_item =
-- Hash table item.
----------------------------------------------------------------------------------------------------

    end c_hash_table_item;

----------------------------------------------------------------------------------------------------
class private c_hash_table =
-- Hash table.
----------------------------------------------------------------------------------------------------

    ------------------------------------------------------------------------------------------------
    static init =
    -- Initializes the hash table.
    --   When [homogenous] is set to True, then only items of type [item_type] are permitted in the 
    -- hash table, otherwise only items of type [item_type] and all its descendants. All hash table
    -- manipulation procedures raise [list_error] when the type of an item violates this rule.
    ------------------------------------------------------------------------------------------------
    begin
      -- set up basic parameters
      this.modulus:=modulus;
      this.item_type:=item_type;
      this.homogenous:=homogenous;
     
      -- create the actual hash table
      new this.hash_table range this.modulus;
      end init;



    ------------------------------------------------------------------------------------------------
    static store =
    -- Inserts the given [item] into the hash table.
    ------------------------------------------------------------------------------------------------
    var
      slot         : p_hash_slot;

    begin
      -- select a slot
      slot:=^hash_table^[item^.item_id mod modulus];

      -- insert into it
      if slot^.last<>nil
        then slot^.last^.next:=item;
        else slot^.first:=item;
        end if;
      item^.prev:=slot^.last;
      item^.next:=nil;
      slot^.last:=item;

      -- reflect the change of the number of items in the slot
      succ slot^.count;
      end store;



    ------------------------------------------------------------------------------------------------
    static find =
    -- Finds and [item] by its [id]. When there is no item with such an [id] in the hash table, 
    -- sets [item] to NIL.
    ------------------------------------------------------------------------------------------------
    begin
      -- try to find the item
      item:=hash_table^[id mod modulus].first;
      while item<>nil and then item^.item_id<>id loop
        item:=item^.next;
        end loop;
      end find;



    ------------------------------------------------------------------------------------------------
    override insert =
    -- Inserts the given [item] into the container.
    ------------------------------------------------------------------------------------------------
    begin
      -- assign an ID
      assign_hash_id(item);

      -- store into the hash table
      store(item);
      end insert;



    ------------------------------------------------------------------------------------------------
    override remove =
    -- Removes the given [item] from the container.
    ------------------------------------------------------------------------------------------------
    var
      slot         : p_hash_slot;

    begin
      -- select a slot
      slot:=^hash_table^[p_hash_table_item(item)^.item_id mod modulus];

      -- remove the item from the slot
      if p_hash_table_item(item)^.next<>nil
        then p_hash_table_item(item)^.next^.prev:=p_hash_table_item(item)^.prev
        else slot^.last:=p_hash_table_item(item)^.prev;
        end if;
      if p_hash_table_item(item)^.prev<>nil
        then p_hash_table_item(item)^.prev^.next:=p_hash_table_item(item)^.next
        else slot^.first:=p_hash_table_item(item)^.next;
        end if;
      p_hash_table_item(item)^.prev:=nil;
      p_hash_table_item(item)^.next:=nil;

      -- reflect the change of the number of items in the slot
      pred slot^.count;
      end remove;



    ------------------------------------------------------------------------------------------------
    override delete =
    -- Removes and discards the given [item] from the container. Sets value of [item] to nil.
    ------------------------------------------------------------------------------------------------
    begin
      -- remove from the hash table
      remove(item);

      -- and discard
      discard item;
      end delete;



    ------------------------------------------------------------------------------------------------
    override delete_all =
    -- Removes and discards all items in the container.
    ------------------------------------------------------------------------------------------------
    begin
      raise feature_not_implemented;
      end delete_all;



    ------------------------------------------------------------------------------------------------
    virtual assign_hash_id =
    -- Assigns an ID to the given [item].
    ------------------------------------------------------------------------------------------------
    begin
      raise feature_not_implemented;
      end assign_hash_id;



    ------------------------------------------------------------------------------------------------
    exit =
    -- Finalization.
    ------------------------------------------------------------------------------------------------
    begin
      discard hash_table;
      end exit;

    end c_hash_table;



----------------------------------------------------------------------------------------------------
class private c_auto_hash_table = 
-- Hash table with automatically assigned incremental item IDs.
----------------------------------------------------------------------------------------------------

    var
      next_id      : t_hash_item_id := 1;        -- next ID to be assigned

    ------------------------------------------------------------------------------------------------
    override assign_hash_id =
    -- Assigns an ID to the given [item].
    ------------------------------------------------------------------------------------------------
    var
      min_id       : t_hash_item_id;             -- ID of the slot with the minimum number of items
      min_count    : t_unsigned;                 -- minimal number of items in a slot

    begin
      -- find the slot with the least number of items
      min_count:=min_count:last;
      min_id:=0;
      for i in hash_table^:range loop 
        -- check if this slot is better than the best known slot or not
        if hash_table^[(next_id+i) mod modulus].count<min_count then
          min_count:=hash_table^[(next_id+i) mod modulus].count;
          min_id:=i;

          -- if the slot is empty, there can't be any better slot
          if min_count=0 then 
            break;
            end if;
          end if;
        end loop;

      -- assign an ID to the item
      item^.item_id:=next_id+min_id;

      -- calucate the least next item ID
      next_id+min_id+1;
      end assign_hash_id;

    end c_auto_hash_table;



end hash_tables;